<html>
<head>
	<title>lms</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script
		type="text/javascript"
		src="https://code.jquery.com/jquery-3.3.1.min.js"
		integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		crossorigin="anonymous"></script>
	<script
		type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"
		></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/jqtree/1.4.12/jqtree.css" rel="stylesheet" />
	<script
		type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jqtree/1.4.12/tree.jquery.js"
		></script>
	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
	<script
		type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"
		></script>

	<link href="/static/lmsapp.css" rel="stylesheet" />
	<link href="/static/popup.css" rel="stylesheet" />
	<script src="/static/tools.js"></script>
	<script src="/static/rtx.js"></script>
	<script>
		var session = null;
		$(document).ready(function() {
			var root = $.cookie("rtx_prefix");
			if( root === undefined )
				window.location = "/login.html";
			session = RtxServer(root);
			session.sid = $.cookie("rtx_sid");

			resize_event();
			route_pathtail($.cookie("pathtail"));
		});

		function route_pathtail(pathtail) {
			if( pathtail === undefined ) {
				return;
			}

			var xx = pathtail.match(/^contact\/([-a-z0-9]*)$/);
			if( xx !== null ) {
				session.get("api/persona/"+xx[1],
					null, show_contact_details, show_contact_error);
			}

			var xx = pathtail.match(/^search\/([-a-z0-9]*)$/);
		}

		function search_submit() {
			params = {frag: $("#contact_bit").val()}
			session.get("api/personas/list", params, show_contact_list);
			return false;
		}

		function show_contact_list(content) {
			window.history.pushState("contact", "persona.l_name",
				"/contacts/search?query="+$("#contact_bit").val());

			var table = content.main_table();

			if( table.length > 15 )
				$("#result-warning").append("<p>only showing 15 results</p>");
			else
				$("#result-warning").empty();

			table = table.slice(0, 15);

			var grid = $('#contact_data');
			grid.jsGrid({
				width: "100%",
				sorting: "true",
				rowClick: row_details,
				data: table,
				fields: jsGrid_columns(content.main_table_columns())
			});
		}

		function row_details(args) {
			session.get("api/persona/"+args.item.id, 
				null, show_contact_details, show_contact_error);
		}

		function bit_html(bit) {
			var es = function(x) { return (x === null) ? "" : x; };
			var ns = function(x) { return (x == "") ? null : x };
			var bd = bit.bit_data;
			var lines = [];
			if( bit.bit_type == "street_addresses" ) {
				var addr3 = [es(bd["city"]), es(bd["state"]), es(bd["zip"])];

				var addresses = [
						ns(bd["address1"]),
						ns(bd["address2"]),
						addr3.join(" "),
						ns(bd["country"])];
				lines = addresses.filter(function(x) {return x !== null});
			}
			else if( bit.bit_type == "urls" ) {
				var labeled = [];
				var xurl = ns(bd['url']) !== null ? "<a href=\""+bd["url"]+"\">"+bd["url"]+"</a>" : " -- ";
				labeled.push(['URL', xurl]);
				if ( ns(bd["username"]) !== null || ns(bd["password"]) !== null ) {
					labeled.push(["Username", es(bd["username"])]);
					copywrapper = function (bit_id) {
						bits.forEach(function(elt) {
							if( elt["id"] == bit_id ){
								// https://stackoverflow.com/questions/41094318/firefox-document-execcommand-cut-copy-was-denied-because-it-was-not-calle
								copyTextToClipboard(elt.bit_data["password"]);
								var popup = $('#pwpopup_'+bit_id.replace(/-/g, ''));
								popup[0].classList.toggle("show");
								setTimeout(function() {
										popup[0].classList.toggle("show");
								}, 3000);
							}
						});
					};
					localurl = "copywrapper('"+bit["id"]+"')";
					var popid = 'pwpopup_'+bit["id"].replace(/-/g, '');
					var pwhtml = 
						"<span class=\"popup\">" + 
						"<button onclick=\""+localurl+"\">Copy Password</button>" + 
						"<span class=\"popupText\" id=\""+popid+"\">Password Copied</span>" +
						"</span>"
					labeled.push(["Password", pwhtml]);
				}
				labeled.forEach(function(x) {
					lines.push(x[0] + ": " + x[1]);
				});
			}
			else if( bit.bit_type == "phone_numbers" ) {
				lines.push(bd["number"]);
			}
			else if( bit.bit_type == "email_addresses" ) {
				var xemail = ns(bd['email']) !== null ? "<a href=\"mailto:"+bd["email"]+"\">"+bd["email"]+"</a>" : " -- ";
				lines.push(xemail);
			}
			if( ns(bit.name) !== null ) {
				lines.unshift(bit.name);
			}
			if( ns(bit.memo) !== null ) {
				lines.push("(memo)");
			}
			return lines.join("<br />");
		}

		function show_contact_details(content) {
			persona = content.table("persona");
			bits = content.table("bits");

			window.history.pushState("contact", "persona.l_name",
				"/contacts/contact/"+persona[0].id);

			var detdiv = $("#contact_detail");
			detdiv.empty();

			var es = function(x) { return (x === null) ? "" : x; };
			var ns = function(x) { return (x == "") ? null : x };
			var full_name = persona[0].l_name;
			if( es(persona[0].f_name) != "" ) {
				full_name = persona[0].f_name + " " + persona[0].l_name;
			}
			detdiv.append("<h1>"+full_name+"</h1>");
			detdiv.append("<p>"+persona[0].memo.replace(/\n/g, "<br />")+"</p>");

			bits.forEach(function(elt) {
				detdiv.append("<p>"+bit_html(elt)+"</p>");
			});
		}

		function show_contact_error(xx) {
			var detdiv = $("#contact_detail");
			detdiv.empty();

			detdiv.html("<p>error getting contact</p>");
		}

		function resize_event() {
			var char_width = parseFloat($("html").css("font-size"));
			var w = $(window).width() / char_width;
			if( w < 40 ) {
				// console.log("resizing skinny -- "+w);
				$("#search_wrapper")
					.removeClass("search_results2_wide")
					.addClass("search_results2_narrow");
				$("#contact_detail")
					.removeClass("row_detail_wide")
					.addClass("row_detail_narrow");
			} else {
				// console.log("resizing wide -- "+w);
				$("#search_wrapper")
					.removeClass("search_results2_narrow")
					.addClass("search_results2_wide");
				$("#contact_detail")
					.removeClass("row_detail_narrow")
					.addClass("row_detail_wide");
			}
		}

</script>
</head>
<body onresize="resize_event()">
<div class="banner">
	<h1>lms</h1>
	<p id="userprof"></p>
</div>
<div class="tab-container">
	<a href="/contacts.html" class="tabopt" id="tabopt2">Contacts</a>
	<a href="/finances.html" class="tabopt" id="tabopt1">Finances</a>
	<a href="/application.html" class="tabopt" id="tabopt3">Application</a>
</div>

<div class="multipane_body">
	<div class="search_results2" id="search_wrapper">
		<form onsubmit="return search_submit();">
		<table class="search">
			<tr>
				<td>Search: </td>
				<td><input type="text" id="contact_bit" /></td>
				<td><input type="submit" value="Search" /></td>
			</tr>
		</table>
		</form>

		<div class="search_results" id="result-warning">
		</div>

		<div class="search_results" id="contact_data" style="width: 100%">
		</div>
	</div>

	<div class="row_detail" id="contact_detail">
	</div>
</div>

<div class="diag">
<h2>Diagnostics</h2>

<p>The <a href="/api/ping">ping endpoint</a> is not authenticated and is useful for
establishing basic connectivity and latency checks.</p>
</div>

</body>
</html>
